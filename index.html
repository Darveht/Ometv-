<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BealyChat - Videollamadas Aleatorias</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics-compat.js"></script>
  <style>
    /* ====================== ESTILOS GENERALES ====================== */
    :root {
      --primary-color: #fe2c55;
      --secondary-color: #25f4ee;
      --dark-bg: #121212;
      --light-text: #ffffff;
      --gray-text: #a7a7a7;
      --card-bg: #1e1e1e;
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: var(--dark-bg);
      color: var(--light-text);
      overflow-x: hidden;
    }
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    /* Marca de agua fija */
    .watermark {
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 18px;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.7);
      z-index: 1000;
      pointer-events: none;
    }
    /* Ícono de ajustes (settings) en esquina superior derecha */
    .settings-icon {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1100;
      width: 40px;
      cursor: pointer;
    }
    /* Ícono de reporte fijo debajo del de ajustes */
    .report-icon {
      position: fixed;
      top: 60px;
      right: 10px;
      z-index: 1100;
      width: 40px;
      cursor: pointer;
    }
    .screen {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      background-color: var(--dark-bg);
      transition: transform 0.5s ease;
      overflow: hidden;
    }
    .screen.active {
      transform: translateX(0);
    }
    .screen:not(.active) {
      transform: translateX(100%);
    }
    .screen-content {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .logo {
      margin-bottom: 30px;
      margin-top: 40px;
    }
    .logo h1 {
      font-size: 32px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--gray-text);
      font-size: 14px;
    }
    .input-group {
      position: relative;
    }
    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-text);
    }
    input, select {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: var(--card-bg);
      color: var(--light-text);
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
    }
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      margin-top: 10px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }
    .btn-outline:hover {
      background-color: rgba(254, 44, 85, 0.1);
    }
    .links {
      margin: 20px 0;
      text-align: center;
    }
    .links a {
      color: var(--secondary-color);
      text-decoration: none;
      font-size: 14px;
    }
    .divider {
      display: flex;
      align-items: center;
      margin: 30px 0;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background-color: #333;
    }
    .divider span {
      margin: 0 15px;
      color: var(--gray-text);
      font-size: 14px;
    }
    .social-login {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    .social-btn {
      width: 50px;
      height: 50px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--card-bg);
      color: var(--light-text);
      font-size: 20px;
      border: 1px solid #333;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .social-btn:hover {
      transform: scale(1.05);
    }
    .avatar-upload {
      width: 120px;
      height: 120px;
      border-radius: 60px;
      background-color: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      position: relative;
      overflow: hidden;
      border: 2px dashed #333;
      cursor: pointer;
    }
    .avatar-upload i {
      font-size: 40px;
      color: var(--gray-text);
    }
    .avatar-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: var(--gray-text);
    }
    /* ====================== PANTALLA DE VIDEOLLAMADA ====================== */
    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
      background-color: #000;
    }
    .remote-video {
      width: 100%;
      height: 100%;
      position: relative;
      background-color: #000;
      overflow: hidden;
    }
    .remote-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      margin: 0;
      padding: 0;
    }
    /* Controles y swipe */
    .video-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 11;
    }
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 25px;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .control-btn:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    .swipe-hint {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 30px;
      z-index: 10;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    .user-info {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }
    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 15px;
      object-fit: cover;
    }
    .user-info span {
      font-size: 14px;
      font-weight: bold;
    }
    .connecting {
      position: absolute;
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: rgba(0, 0, 0, 0.7) 
                  url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif') 
                  center center/cover no-repeat;
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .connecting.active {
      opacity: 1;
      pointer-events: auto;
    }
    /* ====================== PANTALLA DE FECHA DE NACIMIENTO ====================== */
    .birthdate-container {
      padding: 40px 20px;
    }
    .birthdate-container h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .birthdate-container input[type="date"] {
      width: 100%;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: var(--card-bg);
      color: var(--light-text);
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    .birthdate-container input[type="date"]:focus {
      border-color: var(--primary-color);
    }
    /* ====================== PANTALLA DE CUENTA BLOQUEADA ====================== */
    .blocked-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      background-color: var(--dark-bg);
      color: var(--light-text);
    }
    .blocked-screen h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }
    .blocked-screen p {
      font-size: 18px;
    }
    /* ====================== MODAL DE PANTALLA COMPLETA: EDITAR PERFIL ====================== */
    .full-screen-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      z-index: 1200;
      overflow-y: auto;
      padding: 20px;
    }
    .full-screen-modal.active {
      display: block;
    }
    .full-screen-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin: 40px auto;
      position: relative;
    }
    .full-screen-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: var(--light-text);
    }
    /* ====================== GRID DE FOTOS ====================== */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 10px;
      margin-top: 20px;
    }
    .photo-grid .photo-slot {
      width: 100%;
      padding-top: 100%;
      position: relative;
      background-color: #333;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }
    .photo-grid .photo-slot img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* ====================== MODAL DE REPORTE FULL SCREEN ====================== */
    .report-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      z-index: 1300;
      overflow-y: auto;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    .report-modal.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .report-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin: 40px auto;
      position: relative;
    }
    .report-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: var(--light-text);
    }
    .report-options {
      text-align: left;
      margin: 20px 0;
    }
    .report-options label {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .report-status {
      margin-top: 20px;
      text-align: center;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Marca de agua -->
  <div class="watermark">BealyChat</div>
  <!-- Ícono de Ajustes -->
  <img class="settings-icon" src="https://images.vexels.com/media/users/3/153359/isolated/preview/f253c46ff6fb727415fc70750ac1fb6e-configuracion-del-sistema-icono-de-trazo-de-color.png?w=360" alt="Ajustes" onclick="openProfileModal()">
  <!-- Ícono de Reporte, ubicado justo debajo del ícono de Ajustes -->
  <img class="report-icon" src="https://cdn-icons-png.flaticon.com/512/13984/13984890.png" alt="Reportar" onclick="openReportModal()">

  <div class="container">
    <!-- PANTALLAS (LOGIN, REGISTRO, RECUPERAR, PERFIL, FECHA NACIMIENTO, PAÍS, VIDEOLLAMADA, BLOQUEADO) -->
    <div class="screen active" id="loginScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>BealyChat</h1>
          <p>Conecta con personas de todo el mundo</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="email" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <div class="form-group">
            <label for="password">Contraseña</label>
            <div class="input-group" style="position: relative;">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="loginUser()">Iniciar Sesión</button>
        </form>
        <div class="links">
          <a href="#" onclick="toggleForm('forgotPasswordForm')">¿Olvidaste tu contraseña?</a>
        </div>
        <div class="divider"><span>O continúa con</span></div>
        <div class="social-login">
          <div class="social-btn"><i class="fab fa-google"></i></div>
          <div class="social-btn"><i class="fab fa-facebook-f"></i></div>
          <div class="social-btn"><i class="fab fa-apple"></i></div>
        </div>
        <div>
          <p>¿No tienes una cuenta? <a href="#" onclick="toggleForm('registerForm')" style="color: var(--secondary-color);">Regístrate</a></p>
        </div>
      </div>
    </div>

    <div class="screen" id="registerScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>BealyChat</h1>
          <p>Crea tu cuenta</p>
        </div>
        <form id="registerForm">
          <div class="form-group">
            <label for="registerEmail">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="registerEmail" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <div class="form-group">
            <label for="registerPassword">Contraseña</label>
            <div class="input-group" style="position: relative;">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="registerPassword" placeholder="Crea una contraseña" required>
              <img id="passwordMonkey" src="https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f648.gif" style="display: none; position: absolute; top: -20px; right: 10px; width: 30px;">
            </div>
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirmar contraseña</label>
            <div class="input-group" style="position: relative;">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="confirmPassword" placeholder="Confirma tu contraseña" required>
              <img id="passwordMonkeyConfirm" src="https://images.emojiterra.com/google/noto-emoji/animated-emoji/1f648.gif" style="display: none; position: absolute; top: -20px; right: 10px; width: 30px;">
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="registerUser()">Registrarse</button>
        </form>
        <div class="divider"><span>O regístrate con</span></div>
        <div class="social-login">
          <div class="social-btn"><i class="fab fa-google"></i></div>
          <div class="social-btn"><i class="fab fa-facebook-f"></i></div>
          <div class="social-btn"><i class="fab fa-apple"></i></div>
        </div>
        <div>
          <p>¿Ya tienes una cuenta? <a href="#" onclick="goToScreen('loginScreen')" style="color: var(--secondary-color);">Inicia sesión</a></p>
        </div>
      </div>
    </div>

    <div class="screen" id="forgotPasswordScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>BealyChat</h1>
          <p>Recupera tu contraseña</p>
        </div>
        <form id="forgotPasswordForm">
          <div class="form-group">
            <label for="resetEmail">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="resetEmail" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary">Enviar enlace de recuperación</button>
          <button type="button" class="btn btn-outline mt-3" onclick="goToScreen('loginScreen')">Volver a iniciar sesión</button>
        </form>
      </div>
    </div>

    <div class="screen" id="profileSetupScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>BealyChat</h1>
          <p>Configura tu perfil</p>
        </div>
        <div>
          <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
            <input type="file" id="avatarInput" style="display: none;" accept="image/*">
            <i class="fa-solid fa-camera"></i>
            <img id="avatarPreview" src="" alt="Avatar">
          </div>
          <div class="form-group">
            <label for="username">Nombre de usuario</label>
            <div class="input-group">
              <i class="fa-solid fa-user"></i>
              <input type="text" id="username" placeholder="Elige un nombre de usuario" required>
            </div>
          </div>
          <!-- Continuar a la siguiente pantalla: Fecha de nacimiento -->
          <button type="button" class="btn btn-primary mt-4" onclick="goToScreen('birthDateScreen')">Continuar</button>
        </div>
      </div>
    </div>

    <div class="screen" id="birthDateScreen">
      <div class="screen-content birthdate-container">
        <h2>Selecciona tu fecha de nacimiento</h2>
        <input type="date" id="birthDateInput" required>
        <button type="button" class="btn btn-primary mt-4" onclick="validateBirthDate()">Continuar</button>
      </div>
    </div>

    <div class="screen" id="countryScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>BealyChat</h1>
          <p>Selecciona tu país</p>
        </div>
        <div>
          <div class="form-group">
            <label for="country">País</label>
            <div class="input-group">
              <i class="fa-solid fa-globe"></i>
              <select id="country">
                <option value="" disabled selected>Selecciona tu país</option>
                <option value="US">Estados Unidos</option>
                <option value="MX">México</option>
                <option value="ES">España</option>
                <option value="KR">Corea del Sur</option>
                <option value="CN">China</option>
                <option value="OT">Otro</option>
              </select>
            </div>
          </div>
          <button type="button" class="btn btn-primary mt-4" onclick="updateProfileAndConnect()">Conectar ahora</button>
        </div>
      </div>
    </div>

    <div class="screen" id="videoCallScreen">
      <div class="video-container">
        <div class="remote-video" id="remoteVideoContainer">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="user-info" id="remoteUserInfo">
            <img id="remoteAvatar" src="/api/placeholder/30/30" alt="User">
            <span id="remoteName"></span>
          </div>
          <div class="connecting" id="connectingIndicator">
            <div style="text-align:center;">
              <i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i>
              <p style="margin-top:10px;">Conectando...</p>
            </div>
          </div>
        </div>
        <div class="video-controls">
          <div class="control-btn" onclick="toggleAudio()">
            <i class="fa-solid fa-microphone-slash" id="micIcon"></i>
          </div>
          <div class="control-btn" onclick="toggleVideo()">
            <i class="fa-solid fa-video-slash" id="videoIcon"></i>
          </div>
          <div class="control-btn" onclick="restartCall()">
            <i class="fa-solid fa-arrows-rotate"></i>
          </div>
        </div>
        <div class="swipe-hint"><i class="fa-solid fa-chevron-right"></i></div>
      </div>
    </div>

    <div class="screen" id="blockedScreen">
      <div class="screen-content blocked-screen">
        <h2>Lo sentimos</h2>
        <p>
          Su cuenta ha sido bloqueada porque es menor de edad o por infracciones a la comunidad.<br>
          No podrá acceder a la aplicación.<br>
          Su cuenta estará disponible dentro de tres días aproximadamente.<br>
          Si cree que es un error, póngase en contacto con soporte.
        </p>
      </div>
    </div>
  </div>

  <!-- ====================== MODAL FULL SCREEN: EDITAR PERFIL ====================== -->
  <div class="full-screen-modal" id="profileModal">
    <div class="full-screen-content">
      <span class="full-screen-close" onclick="closeProfileModal()">&times;</span>
      <h2>Editar Perfil</h2>
      <!-- Contenido de edición del perfil (puedes expandirlo según tus necesidades) -->
      <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
        <input type="file" id="avatarInputProfile" style="display: none;" accept="image/*">
        <i class="fa-solid fa-camera"></i>
        <img id="avatarPreviewProfile" src="" alt="Avatar">
      </div>
      <div class="form-group">
        <label for="usernameProfile">Nombre de usuario</label>
        <div class="input-group">
          <i class="fa-solid fa-user"></i>
          <input type="text" id="usernameProfile" placeholder="Elige un nombre de usuario">
        </div>
      </div>
      <div class="form-group">
        <label for="emailProfile">Correo electrónico</label>
        <div class="input-group">
          <i class="fa-solid fa-envelope"></i>
          <input type="email" id="emailProfile" placeholder="Tu correo electrónico" disabled>
        </div>
      </div>
      <!-- Sección de fotos en cuadrícula -->
      <h3>Mis Fotos</h3>
      <div class="photo-grid" id="photoGrid">
        <div class="photo-slot" onclick="uploadPhoto(0)" id="slot0"></div>
        <div class="photo-slot" onclick="uploadPhoto(1)" id="slot1"></div>
        <div class="photo-slot" onclick="uploadPhoto(2)" id="slot2"></div>
        <div class="photo-slot" onclick="uploadPhoto(3)" id="slot3"></div>
        <div class="photo-slot" onclick="uploadPhoto(4)" id="slot4"></div>
        <div class="photo-slot" onclick="uploadPhoto(5)" id="slot5"></div>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
      <br>
      <button type="button" class="btn btn-primary" onclick="savePhotos()">Guardar</button>
      <br><br>
      <button type="button" class="btn btn-outline" onclick="updateProfileData()">Actualizar Perfil</button>
    </div>
  </div>

  <!-- ====================== MODAL FULL SCREEN: REPORTAR USUARIO (ESTILO MODERNO) ====================== -->
  <div class="report-modal" id="reportModal">
    <div class="report-content">
      <span class="report-close" onclick="closeReportModal()">&times;</span>
      <h2>Reportar Usuario</h2>
      <p>Selecciona las opciones que describen la infracción:</p>
      <div class="report-options">
        <label><input type="checkbox" value="desnudos" id="reportDesnudos"> Desnudos</label>
        <label><input type="checkbox" value="violencia_sexual" id="reportViolencia"> Violencia sexual</label>
        <label><input type="checkbox" value="comportamiento_explicito" id="reportExplicito"> Contenido explícito</label>
        <label><input type="checkbox" value="menor_de_edad" id="reportMenor"> Posible usuario menor de edad</label>
      </div>
      <button type="button" class="btn btn-primary" onclick="submitReport()">Enviar Reporte</button>
      <div class="report-status" id="reportStatus"></div>
    </div>
  </div>

  <script>
    /* ====================== INICIALIZAR FIREBASE ====================== */
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      databaseURL: "TU_DATABASE_URL",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID",
      measurementId: "TU_MEASUREMENT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    const auth = firebase.auth();
    const database = firebase.database();

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log("Persistencia configurada"))
      .catch(error => console.error("Error configurando persistencia:", error));

    /* ====================== VARIABLES GLOBALES ====================== */
    let currentUser = null;
    let currentProfile = null;
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let currentCallId = null;
    // Array para almacenar las fotos subidas en el modal de edición de perfil
    let userPhotos = [null, null, null, null, null, null];

    const configuration = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:relay1.expressturn.com:3478",
          username: "efMS1DHVA7SM7GJ775",
          credential: "n2IsFT3aaml3waju"
        }
      ]
    };

    /* ====================== MANEJO DE PANTALLAS ====================== */
    function goToScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if(screenId === 'videoCallScreen'){
        startLocalStream();
        showConnecting();
        startMatching();
      }
      if(screenId === 'countryScreen'){
        autoDetectCountry();
      }
    }
    function toggleForm(formType) {
      if(formType === 'registerForm'){
        goToScreen('registerScreen');
      } else if(formType === 'forgotPasswordForm'){
        goToScreen('forgotPasswordScreen');
      }
    }

    /* ====================== REGISTRO / LOGIN ====================== */
    function registerUser() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if(password !== confirmPassword){
        alert("Las contraseñas no coinciden");
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Registro exitoso:", userCredential.user);
          alert("Registro exitoso, completa tu configuración de perfil");
          goToScreen('profileSetupScreen');
        })
        .catch(error => alert("Error al registrarse: " + error.message));
    }
    function loginUser() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Login exitoso:", userCredential.user);
          goToScreen('profileSetupScreen');
        })
        .catch(error => alert("Error al iniciar sesión: " + error.message));
    }
    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = user;
        console.log("Usuario autenticado:", user.uid);
        database.ref('profiles/' + user.uid).once('value', snapshot => {
          if(snapshot.exists()){
            currentProfile = snapshot.val();
            if(currentProfile.username && currentProfile.avatar_url && currentProfile.country && currentProfile.birthDate){
              // Verificar si el usuario está bloqueado
              if(currentProfile.blockedUntil) {
                const now = new Date();
                const blockedUntil = new Date(currentProfile.blockedUntil);
                if(now < blockedUntil) {
                  goToScreen('blockedScreen');
                  return;
                }
              }
              goToScreen('videoCallScreen');
            } else if(!currentProfile.birthDate) {
              goToScreen('birthDateScreen');
            } else {
              goToScreen('profileSetupScreen');
            }
          }
        });
      } else {
        currentUser = null;
        currentProfile = null;
      }
    });

    /* ====================== PERFIL ====================== */
    document.getElementById('avatarInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(event){
          const avatarPreview = document.getElementById('avatarPreview');
          avatarPreview.src = event.target.result;
          avatarPreview.style.display = 'block';
          document.querySelector('.avatar-upload i').style.display = 'none';
        }
        reader.readAsDataURL(file);
      }
    });
    async function updateProfile() {
      if(!currentUser){
        alert("No hay usuario autenticado");
        return;
      }
      const username = document.getElementById('username').value;
      const country = document.getElementById('country') ? document.getElementById('country').value : "";
      const birthDate = currentProfile && currentProfile.birthDate ? currentProfile.birthDate : "";
      const avatar_url = document.getElementById('avatarPreview').src || "";
      currentProfile = { username, country, birthDate, avatar_url };
      console.log("Actualizando perfil:", currentProfile);
      return database.ref('profiles/' + currentUser.uid).update(currentProfile);
    }
    function updateBirthDateAndContinue() {
      const birthDate = document.getElementById('birthDateInput').value;
      if (!birthDate) {
        alert("Por favor, selecciona tu fecha de nacimiento");
        return;
      }
      currentProfile = currentProfile || {};
      currentProfile.birthDate = birthDate;
      updateProfile().then(() => {
        goToScreen('countryScreen');
      });
    }
    async function updateProfileAndConnect(){
      try {
        if(document.getElementById('username').value === ""){
          alert("Ingresa un nombre de usuario");
          return;
        }
        await updateProfile();
        goToScreen('videoCallScreen');
      } catch(error){
        alert("Error al actualizar el perfil: " + error);
      }
    }
    // Función para actualizar los datos desde el modal de edición de perfil
    function updateProfileData() {
      const username = document.getElementById('usernameProfile').value;
      if(username === ""){
        alert("Ingresa un nombre de usuario");
        return;
      }
      // Actualizamos el perfil en la base de datos
      const updatedProfile = {
        username: username,
        avatar_url: document.getElementById('avatarPreviewProfile').src || currentProfile.avatar_url
      };
      database.ref('profiles/' + currentUser.uid).update(updatedProfile)
        .then(() => {
          alert("Perfil actualizado");
          closeProfileModal();
        })
        .catch(err => alert("Error al actualizar perfil: " + err));
    }

    /* ====================== VALIDACIÓN DE FECHA DE NACIMIENTO ====================== */
    function validateBirthDate() {
      const birthDateValue = document.getElementById('birthDateInput').value;
      if (!birthDateValue) {
        alert("Selecciona tu fecha de nacimiento");
        return;
      }
      const birthDate = new Date(birthDateValue);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if(m < 0 || (m === 0 && today.getDate() < birthDate.getDate())){
        age--;
      }
      console.log("Edad calculada:", age);
      if(age < 18){
        goToScreen('blockedScreen');
      } else {
        updateBirthDateAndContinue();
      }
    }

    /* ====================== AUTO DETECTAR PAÍS ====================== */
    function autoDetectCountry(){
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          const countryCode = data.country_code;
          const countrySelect = document.getElementById('country');
          if(countrySelect){
            const option = [...countrySelect.options].find(o => o.value === countryCode);
            if(option){
              countrySelect.value = countryCode;
            }
          }
        })
        .catch(error => console.error('Error detectando país:', error));
    }

    /* ====================== PRESENCIA Y MATCHING ====================== */
    async function startMatching(){
      if(!currentUser || !currentProfile || !currentProfile.username || !currentProfile.avatar_url || !currentProfile.country || !currentProfile.birthDate){
        console.error("Perfil incompleto, no se puede marcar como online");
        return;
      }
      const userRef = database.ref('onlineUsers/' + currentUser.uid);
      await userRef.set({
        username: currentProfile.username,
        avatar_url: currentProfile.avatar_url,
        country: currentProfile.country,
        birthDate: currentProfile.birthDate,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      userRef.onDisconnect().remove();
      findRandomUser();
    }
    async function findRandomUser(){
      const snapshot = await database.ref('onlineUsers').once('value');
      const online = snapshot.val() || {};
      const uids = Object.keys(online).filter(uid => uid !== currentUser.uid);
      if(uids.length === 0){
        console.log("Nadie disponible, reintentando en 5s...");
        setTimeout(findRandomUser, 5000);
        return;
      }
      const randomUid = uids[Math.floor(Math.random() * uids.length)];
      createCall(randomUid);
    }
    async function createCall(remoteUid){
      const callId = database.ref('calls').push().key;
      currentCallId = callId;
      await database.ref('calls/' + callId + '/participants').set({
        caller: currentUser.uid,
        callee: remoteUid
      });
      startWebRTC(callId, true);
    }
    database.ref('calls').on('child_added', snapshot => {
      const callId = snapshot.key;
      const callData = snapshot.val();
      if(!callData || !callData.participants) return;
      const { caller, callee } = callData.participants;
      if(callee === currentUser?.uid){
        currentCallId = callId;
        startWebRTC(callId, false);
      }
    });

    /* ====================== WEBRTC ====================== */
    async function startLocalStream(){
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      } catch(error){
        console.error("Error accediendo a cámara y micrófono:", error);
        alert("No se pudo acceder a la cámara/micrófono. Verifica los permisos.");
      }
    }
    function startWebRTC(callId, isCaller){
      peerConnection = new RTCPeerConnection(configuration);
      console.log("Iniciando WebRTC, es caller?", isCaller);
      if(localStream){
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
      } else {
        console.warn("No hay stream local disponible");
      }
      peerConnection.ontrack = (event) => {
        console.log("Evento ontrack:", event);
        const remoteVideo = document.getElementById('remoteVideo');
        if(event.streams && event.streams[0]){
          remoteStream = event.streams[0];
          remoteVideo.srcObject = remoteStream;
        } else {
          if(!remoteStream){
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        }
        remoteVideo.play().catch(e => console.error("Error al reproducir video remoto:", e));
        hideConnecting();
      };
      peerConnection.onicecandidate = event => {
        if(event.candidate){
          console.log("Enviando ICE candidate:", event.candidate);
          database.ref(`calls/${callId}/iceCandidates/${currentUser.uid}`).push(JSON.stringify(event.candidate));
        }
      };
      database.ref(`calls/${callId}/iceCandidates`).on('child_added', snapshot => {
        const userUid = snapshot.key;
        if(userUid !== currentUser.uid){
          snapshot.forEach(candidateSnap => {
            const candidateData = candidateSnap.val();
            if(candidateData){
              const candidate = new RTCIceCandidate(JSON.parse(candidateData));
              peerConnection.addIceCandidate(candidate).catch(e => console.error("Error agregando ICE candidate:", e));
            }
          });
        }
      });
      if(isCaller){
        createOffer(callId);
      } else {
        database.ref(`calls/${callId}/offer`).on('value', async snapshot => {
          const offerData = snapshot.val();
          if(offerData){
            try {
              const offer = new RTCSessionDescription(JSON.parse(offerData));
              await peerConnection.setRemoteDescription(offer);
              const answer = await peerConnection.createAnswer();
              await peerConnection.setLocalDescription(answer);
              await database.ref(`calls/${callId}/answer`).set(JSON.stringify(answer));
              console.log("Respuesta enviada");
            } catch(err){
              console.error("Error procesando la oferta:", err);
            }
          }
        });
      }
      database.ref(`calls/${callId}/answer`).on('value', async snapshot => {
        const answerData = snapshot.val();
        if(answerData && peerConnection.signalingState === 'have-local-offer'){
          try {
            const answer = new RTCSessionDescription(JSON.parse(answerData));
            await peerConnection.setRemoteDescription(answer);
            console.log("Respuesta recibida y aplicada");
          } catch(err){
            console.error("Error al aplicar respuesta:", err);
          }
        }
      });
      // Se asigna la información del usuario remoto; si no se encuentra perfil, el nombre queda vacío.
      database.ref(`calls/${callId}/participants`).once('value', snap => {
        const parts = snap.val() || {};
        let remoteUid = isCaller ? parts.callee : parts.caller;
        console.log("remoteUid detectado:", remoteUid);
        if(!remoteUid){
          console.error("No se encontró remoteUid");
          document.getElementById('remoteName').textContent = "";
          document.getElementById('remoteAvatar').src = '/api/placeholder/30/30';
          return;
        }
        database.ref('profiles/' + remoteUid).once('value', userSnap => {
          if(userSnap.exists()){
            const rProfile = userSnap.val();
            document.getElementById('remoteAvatar').src = rProfile.avatar_url || '/api/placeholder/30/30';
            document.getElementById('remoteName').textContent = rProfile.username ? rProfile.username : "";
          } else {
            console.error("No se encontró perfil para remoteUid:", remoteUid);
            document.getElementById('remoteName').textContent = "";
            document.getElementById('remoteAvatar').src = '/api/placeholder/30/30';
          }
        });
      });
    }
    async function createOffer(callId){
      try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await database.ref(`calls/${callId}/offer`).set(JSON.stringify(offer));
        console.log("Oferta creada y enviada");
      } catch(error){
        console.error("Error creando oferta:", error);
      }
    }
    function showConnecting(){
      document.getElementById('connectingIndicator').classList.add('active');
    }
    function hideConnecting(){
      document.getElementById('connectingIndicator').classList.remove('active');
    }
    function toggleAudio(){
      if(!localStream) return;
      localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
      document.getElementById('micIcon').classList.toggle('fa-microphone-slash');
      document.getElementById('micIcon').classList.toggle('fa-microphone');
    }
    function toggleVideo(){
      if(!localStream) return;
      localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
      document.getElementById('videoIcon').classList.toggle('fa-video-slash');
      document.getElementById('videoIcon').classList.toggle('fa-video');
    }
    function restartCall(){
      showConnecting();
      setTimeout(() => {
        hideConnecting();
        if(peerConnection) peerConnection.close();
        peerConnection = null;
        remoteStream = null;
        document.getElementById('remoteVideo').srcObject = null;
        if(currentCallId){
          database.ref('calls/' + currentCallId).remove();
          currentCallId = null;
        }
        findRandomUser();
      }, 2000);
    }
    let touchStartX = 0;
    let touchEndX = 0;
    document.querySelector('.video-container').addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });
    document.querySelector('.video-container').addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      if(touchEndX < touchStartX){
        restartCall();
      }
    });
    document.getElementById('registerPassword').addEventListener('focus', () => {
      document.getElementById('passwordMonkey').style.display = 'block';
    });
    document.getElementById('registerPassword').addEventListener('blur', () => {
      document.getElementById('passwordMonkey').style.display = 'none';
    });
    document.getElementById('confirmPassword').addEventListener('focus', () => {
      document.getElementById('passwordMonkeyConfirm').style.display = 'block';
    });
    document.getElementById('confirmPassword').addEventListener('blur', () => {
      document.getElementById('passwordMonkeyConfirm').style.display = 'none';
    });

    /* ====================== MODAL FULL SCREEN: EDITAR PERFIL ====================== */
    function openProfileModal() {
      // Actualizamos los datos del perfil en el modal
      if(currentUser && currentProfile) {
        document.getElementById('avatarPreviewProfile').src = currentProfile.avatar_url || '/api/placeholder/100/100';
        document.getElementById('usernameProfile').value = currentProfile.username || "";
        document.getElementById('emailProfile').value = currentUser.email;
      }
      document.getElementById('profileModal').classList.add('active');
    }
    function closeProfileModal() {
      document.getElementById('profileModal').classList.remove('active');
    }
    // Función para subir foto en algún slot (usada tanto en edición como en ajustes)
    function uploadPhoto(slotIndex) {
      window.currentPhotoSlot = slotIndex;
      document.getElementById('photoInput').click();
    }
    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          userPhotos[window.currentPhotoSlot] = e.target.result;
          document.getElementById('slot' + window.currentPhotoSlot).innerHTML = `<img src="${e.target.result}" alt="Foto ${window.currentPhotoSlot+1}">`;
        }
        reader.readAsDataURL(file);
      }
    }
    function savePhotos() {
      if(!currentUser) return;
      database.ref('userPhotos/' + currentUser.uid).set(userPhotos)
        .then(() => {
          alert("Fotos guardadas exitosamente");
          // Opcional: cerrar el modal de perfil si se desea
          closeProfileModal();
        })
        .catch(err => alert("Error al guardar fotos: " + err));
    }

    /* ====================== MODAL FULL SCREEN: REPORTAR USUARIO ====================== */
    function openReportModal() {
      document.getElementById('reportModal').classList.add('active');
    }
    function closeReportModal() {
      document.getElementById('reportModal').classList.remove('active');
      document.getElementById('reportStatus').innerHTML = "";
      // Reiniciamos las opciones del reporte
      document.getElementById('reportDesnudos').checked = false;
      document.getElementById('reportViolencia').checked = false;
      document.getElementById('reportExplicito').checked = false;
      document.getElementById('reportMenor').checked = false;
    }
    function submitReport() {
      const reportData = {
        desnudos: document.getElementById('reportDesnudos').checked,
        violencia_sexual: document.getElementById('reportViolencia').checked,
        comportamiento_explicito: document.getElementById('reportExplicito').checked,
        menor_de_edad: document.getElementById('reportMenor').checked,
        reporter: currentUser ? currentUser.uid : "desconocido",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      let reportedUid = null;
      database.ref('calls/' + currentCallId + '/participants').once('value').then(snapshot => {
        const parts = snapshot.val();
        if(parts) {
          reportedUid = (parts.caller === currentUser.uid) ? parts.callee : parts.caller;
          database.ref('reports/' + reportedUid).push(reportData)
            .then(() => {
              document.getElementById('reportStatus').innerHTML = "<p style='color:green;'>Reporte enviado</p>";
              // Simulamos bloqueo si se reporta alguna infracción (en producción se validaría acumulado)
              if(reportData.desnudos || reportData.violencia_sexual || reportData.comportamiento_explicito || reportData.menor_de_edad) {
                const blockedUntil = new Date();
                blockedUntil.setDate(blockedUntil.getDate() + 3);
                database.ref('profiles/' + reportedUid).update({ blockedUntil: blockedUntil.toISOString() });
                if(reportedUid === currentUser.uid) {
                  setTimeout(() => { goToScreen('blockedScreen'); }, 1000);
                }
              }
            })
            .catch(err => {
              document.getElementById('reportStatus').innerHTML = "<p style='color:red;'>Error: " + err.message + "</p>";
            });
        }
      });
    }
  </script>
</body>
</html>
