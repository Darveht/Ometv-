<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Untitled</title>
  

</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoMeet - Videollamadas Aleatorias</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics-compat.js"></script>
  <style>
    /* ====================== ESTILOS GENERALES ====================== */
    :root {
      --primary-color: #fe2c55;
      --secondary-color: #25f4ee;
      --dark-bg: #121212;
      --light-text: #ffffff;
      --gray-text: #a7a7a7;
      --card-bg: #1e1e1e;
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: var(--dark-bg);
      color: var(--light-text);
      overflow-x: hidden;
    }
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    .screen {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      background-color: var(--dark-bg);
      transition: transform 0.5s ease;
      overflow: hidden;
    }
    .screen.active {
      transform: translateX(0);
    }
    .screen:not(.active) {
      transform: translateX(100%);
    }
    .screen-content {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .logo {
      margin-bottom: 30px;
      margin-top: 40px;
    }
    .logo h1 {
      font-size: 32px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--gray-text);
      font-size: 14px;
    }
    .input-group {
      position: relative;
    }
    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray-text);
    }
    input, select {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: var(--card-bg);
      color: var(--light-text);
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
    }
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      margin-top: 10px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }
    .btn-outline:hover {
      background-color: rgba(254, 44, 85, 0.1);
    }
    .links {
      margin: 20px 0;
      text-align: center;
    }
    .links a {
      color: var(--secondary-color);
      text-decoration: none;
      font-size: 14px;
    }
    .divider {
      display: flex;
      align-items: center;
      margin: 30px 0;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background-color: #333;
    }
    .divider span {
      margin: 0 15px;
      color: var(--gray-text);
      font-size: 14px;
    }
    .social-login {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    .social-btn {
      width: 50px;
      height: 50px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--card-bg);
      color: var(--light-text);
      font-size: 20px;
      border: 1px solid #333;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .social-btn:hover {
      transform: scale(1.05);
    }
    .avatar-upload {
      width: 120px;
      height: 120px;
      border-radius: 60px;
      background-color: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      position: relative;
      overflow: hidden;
      border: 2px dashed #333;
      cursor: pointer;
    }
    .avatar-upload i {
      font-size: 40px;
      color: var(--gray-text);
    }
    .avatar-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: var(--gray-text);
    }
    /* ====================== PANTALLA DE VIDEOLLAMADA ====================== */
    .video-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .video-call {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .remote-video, .local-video {
      flex: 1;
      position: relative;
      background-color: #000;
      overflow: hidden;
    }
    .remote-video video, .local-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      margin: 0;
      padding: 0;
    }
    .video-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 10;
    }
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 25px;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .control-btn:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    .swipe-hint {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-size: 30px;
      z-index: 10;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    .user-info {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 10px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }
    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 15px;
      object-fit: cover;
    }
    .user-info span {
      font-size: 14px;
      font-weight: bold;
    }
    .connecting {
      position: absolute;
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: rgba(0, 0, 0, 0.7) 
                  url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif') 
                  center center/cover no-repeat;
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .connecting.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- =========================== LOGIN SCREEN =========================== -->
    <div class="screen active" id="loginScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>VideoMeet</h1>
          <p>Conecta con personas de todo el mundo</p>
        </div>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="email" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <div class="form-group">
            <label for="password">Contraseña</label>
            <div class="input-group">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="loginUser()">Iniciar Sesión</button>
        </form>
        <div class="links">
          <a href="#" onclick="toggleForm('forgotPasswordForm')">¿Olvidaste tu contraseña?</a>
        </div>
        <div class="divider">
          <span>O continúa con</span>
        </div>
        <div class="social-login">
          <div class="social-btn"><i class="fab fa-google"></i></div>
          <div class="social-btn"><i class="fab fa-facebook-f"></i></div>
          <div class="social-btn"><i class="fab fa-apple"></i></div>
        </div>
        <div>
          <p>¿No tienes una cuenta? <a href="#" onclick="toggleForm('registerForm')" style="color: var(--secondary-color);">Regístrate</a></p>
        </div>
      </div>
    </div>

    <!-- =========================== REGISTER SCREEN =========================== -->
    <div class="screen" id="registerScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>VideoMeet</h1>
          <p>Crea tu cuenta</p>
        </div>
        <form id="registerForm">
          <div class="form-group">
            <label for="registerEmail">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="registerEmail" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <div class="form-group">
            <label for="registerPassword">Contraseña</label>
            <div class="input-group">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="registerPassword" placeholder="Crea una contraseña" required>
            </div>
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirmar contraseña</label>
            <div class="input-group">
              <i class="fa-solid fa-lock"></i>
              <input type="password" id="confirmPassword" placeholder="Confirma tu contraseña" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="registerUser()">Registrarse</button>
        </form>
        <div class="divider">
          <span>O regístrate con</span>
        </div>
        <div class="social-login">
          <div class="social-btn"><i class="fab fa-google"></i></div>
          <div class="social-btn"><i class="fab fa-facebook-f"></i></div>
          <div class="social-btn"><i class="fab fa-apple"></i></div>
        </div>
        <div>
          <p>¿Ya tienes una cuenta? <a href="#" onclick="goToScreen('loginScreen')" style="color: var(--secondary-color);">Inicia sesión</a></p>
        </div>
      </div>
    </div>

    <!-- =========================== FORGOT PASSWORD SCREEN =========================== -->
    <div class="screen" id="forgotPasswordScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>VideoMeet</h1>
          <p>Recupera tu contraseña</p>
        </div>
        <form id="forgotPasswordForm">
          <div class="form-group">
            <label for="resetEmail">Correo electrónico</label>
            <div class="input-group">
              <i class="fa-solid fa-envelope"></i>
              <input type="email" id="resetEmail" placeholder="Ingresa tu correo electrónico" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary">Enviar enlace de recuperación</button>
          <button type="button" class="btn btn-outline mt-3" onclick="goToScreen('loginScreen')">Volver a iniciar sesión</button>
        </form>
      </div>
    </div>

    <!-- =========================== PROFILE SETUP SCREEN =========================== -->
    <div class="screen" id="profileSetupScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>VideoMeet</h1>
          <p>Configura tu perfil</p>
        </div>
        <div>
          <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
            <input type="file" id="avatarInput" style="display: none;" accept="image/*">
            <i class="fa-solid fa-camera"></i>
            <img id="avatarPreview" src="" alt="Avatar">
          </div>
          <div class="form-group">
            <label for="username">Nombre de usuario</label>
            <div class="input-group">
              <i class="fa-solid fa-user"></i>
              <input type="text" id="username" placeholder="Elige un nombre de usuario" required>
            </div>
          </div>
          <button type="button" class="btn btn-primary mt-4" onclick="goToScreen('countryScreen')">Continuar</button>
        </div>
      </div>
    </div>

    <!-- =========================== COUNTRY SCREEN =========================== -->
    <div class="screen" id="countryScreen">
      <div class="screen-content">
        <div class="logo">
          <h1>VideoMeet</h1>
          <p>Selecciona tu país</p>
        </div>
        <div>
          <div class="form-group">
            <label for="country">País</label>
            <div class="input-group">
              <i class="fa-solid fa-globe"></i>
              <select id="country">
                <option value="" disabled selected>Selecciona tu país</option>
                <option value="US">Estados Unidos</option>
                <option value="MX">México</option>
                <option value="ES">España</option>
                <option value="KR">Corea del Sur</option>
                <option value="CN">China</option>
                <option value="OT">Otro</option>
              </select>
            </div>
          </div>
          <button type="button" class="btn btn-primary mt-4" onclick="updateProfileAndConnect()">Conectar ahora</button>
        </div>
      </div>
    </div>

    <!-- =========================== VIDEO CALL SCREEN =========================== -->
    <div class="screen" id="videoCallScreen">
      <div class="video-container">
        <div class="video-call">
          <div class="remote-video" id="remoteVideoContainer">
            <!-- Video remoto inicia en mute para permitir autoplay -->
            <video id="remoteVideo" autoplay playsinline muted></video>
            <div class="user-info" id="remoteUserInfo">
              <img id="remoteAvatar" src="/api/placeholder/30/30" alt="User">
              <span id="remoteName">Desconocido</span>
            </div>
            <div class="connecting" id="connectingIndicator">
              <div style="text-align:center;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i>
                <p style="margin-top:10px;">Conectando...</p>
              </div>
            </div>
          </div>
          <div class="local-video">
            <video id="localVideo" autoplay playsinline muted></video>
          </div>
        </div>
        <div class="video-controls">
          <div class="control-btn" onclick="toggleAudio()">
            <i class="fa-solid fa-microphone-slash" id="micIcon"></i>
          </div>
          <div class="control-btn" onclick="toggleVideo()">
            <i class="fa-solid fa-video-slash" id="videoIcon"></i>
          </div>
          <div class="control-btn" onclick="restartCall()">
            <i class="fa-solid fa-arrows-rotate"></i>
          </div>
        </div>
        <div class="swipe-hint">
          <i class="fa-solid fa-chevron-right"></i>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ====================== INICIALIZAR FIREBASE ====================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBziV6Jvh9KQZpsh8HtCtbX51H_qKJgZzM",
  authDomain: "ometv-67dc0.firebaseapp.com",
  databaseURL: "https://ometv-67dc0-default-rtdb.firebaseio.com",
  projectId: "ometv-67dc0",
  storageBucket: "ometv-67dc0.firebasestorage.app",
  messagingSenderId: "874118207646",
  appId: "1:874118207646:web:0068f610484d73705ec38f",
  measurementId: "G-NNSSK6W00L"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    const auth = firebase.auth();
    const database = firebase.database();

    // Configurar persistencia para mantener la sesión activa
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log("Persistencia configurada"))
      .catch(error => console.error("Error configurando persistencia:", error));

    /* ====================== VARIABLES GLOBALES ====================== */
    let currentUser = null;
    let currentProfile = null;
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let currentCallId = null;

    // Configuración STUN/TURN para WebRTC
    const configuration = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:relay1.expressturn.com:3478",
          username: "efMS1DHVA7SM7GJ775",
          credential: "n2IsFT3aaml3waju"
        }
      ]
    };

    /* ====================== MANEJO DE PANTALLAS ====================== */
    function goToScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');

      if(screenId === 'videoCallScreen'){
        startLocalStream();
        showConnecting();
        startMatching();
      }
      if(screenId === 'countryScreen'){
        autoDetectCountry();
      }
    }

    function toggleForm(formType) {
      if(formType === 'registerForm'){
        goToScreen('registerScreen');
      } else if(formType === 'forgotPasswordForm'){
        goToScreen('forgotPasswordScreen');
      }
    }

    /* ====================== REGISTRO / LOGIN ====================== */
    function registerUser() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if(password !== confirmPassword){
        alert("Las contraseñas no coinciden");
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Registro exitoso:", userCredential.user);
          alert("Registro exitoso, completa tu perfil");
          goToScreen('profileSetupScreen');
        })
        .catch(error => alert("Error al registrarse: " + error.message));
    }

    function loginUser() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Login exitoso:", userCredential.user);
          goToScreen('profileSetupScreen');
        })
        .catch(error => alert("Error al iniciar sesión: " + error.message));
    }

    // Detectar cambios en la autenticación
    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = user;
        console.log("Usuario autenticado:", user.uid);
        // Revisar si el perfil ya existe y está completo
        database.ref('profiles/' + user.uid).once('value', snapshot => {
          if(snapshot.exists()){
            currentProfile = snapshot.val();
            if(currentProfile.username && currentProfile.avatar_url && currentProfile.country){
              goToScreen('videoCallScreen');
            } else {
              goToScreen('profileSetupScreen');
            }
          }
        });
      } else {
        currentUser = null;
        currentProfile = null;
      }
    });

    /* ====================== PERFIL ====================== */
    document.getElementById('avatarInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(event){
          const avatarPreview = document.getElementById('avatarPreview');
          avatarPreview.src = event.target.result;
          avatarPreview.style.display = 'block';
          document.querySelector('.avatar-upload i').style.display = 'none';
        }
        reader.readAsDataURL(file);
      }
    });

    async function updateProfile() {
      if(!currentUser){
        alert("No hay usuario autenticado");
        return;
      }
      const username = document.getElementById('username').value;
      const country = document.getElementById('country').value;
      const avatar_url = document.getElementById('avatarPreview').src || "";
      currentProfile = { username, country, avatar_url };
      console.log("Actualizando perfil:", currentProfile);
      return database.ref('profiles/' + currentUser.uid).update(currentProfile);
    }

    async function updateProfileAndConnect(){
      try {
        if(document.getElementById('username').value === ""){
          alert("Ingresa un nombre de usuario");
          return;
        }
        await updateProfile();
        goToScreen('videoCallScreen');
      } catch(error){
        alert("Error al actualizar el perfil: " + error);
      }
    }

    /* ====================== AUTO DETECTAR PAÍS ====================== */
    function autoDetectCountry(){
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          const countryCode = data.country_code;
          const countrySelect = document.getElementById('country');
          if(countrySelect){
            const option = [...countrySelect.options].find(o => o.value === countryCode);
            if(option){
              countrySelect.value = countryCode;
            }
          }
        })
        .catch(error => console.error('Error detectando país:', error));
    }

    /* ====================== PRESENCIA Y MATCHING ====================== */
    async function startMatching(){
      if(!currentUser || !currentProfile || !currentProfile.username || !currentProfile.avatar_url || !currentProfile.country){
        console.error("Perfil incompleto, no se puede marcar como online");
        return;
      }
      // Marcar usuario online en la DB
      const userRef = database.ref('onlineUsers/' + currentUser.uid);
      await userRef.set({
        username: currentProfile.username,
        avatar_url: currentProfile.avatar_url,
        country: currentProfile.country,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      userRef.onDisconnect().remove();
      findRandomUser();
    }

    async function findRandomUser(){
      const snapshot = await database.ref('onlineUsers').once('value');
      const online = snapshot.val() || {};
      const uids = Object.keys(online).filter(uid => uid !== currentUser.uid);
      if(uids.length === 0){
        console.log("Nadie disponible, reintentando en 5s...");
        setTimeout(findRandomUser, 5000);
        return;
      }
      const randomUid = uids[Math.floor(Math.random() * uids.length)];
      createCall(randomUid);
    }

    async function createCall(remoteUid){
      const callId = database.ref('calls').push().key;
      currentCallId = callId;
      await database.ref('calls/' + callId + '/participants').set({
        caller: currentUser.uid,
        callee: remoteUid
      });
      startWebRTC(callId, true);
    }

    // Escuchar nuevas llamadas para quien es "callee"
    database.ref('calls').on('child_added', snapshot => {
      const callId = snapshot.key;
      const callData = snapshot.val();
      if(!callData || !callData.participants) return;
      const { caller, callee } = callData.participants;
      if(callee === currentUser?.uid){
        currentCallId = callId;
        startWebRTC(callId, false);
      }
    });

    /* ====================== WEBRTC ====================== */
    async function startLocalStream(){
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
      } catch(error){
        console.error("Error accediendo a cámara y micrófono:", error);
        alert("No se pudo acceder a la cámara/micrófono. Verifica los permisos.");
      }
    }

    function startWebRTC(callId, isCaller){
      peerConnection = new RTCPeerConnection(configuration);
      console.log("Iniciando WebRTC, es caller?", isCaller);

      // Agregar tracks locales a la conexión
      if(localStream){
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
      } else {
        console.warn("No hay stream local disponible");
      }

      // Manejar recepción de tracks remotos
      peerConnection.ontrack = (event) => {
        console.log("Evento ontrack:", event);
        const remoteVideo = document.getElementById('remoteVideo');
        if(event.streams && event.streams[0]){
          remoteStream = event.streams[0];
          remoteVideo.srcObject = remoteStream;
        } else {
          if(!remoteStream){
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;
          }
          remoteStream.addTrack(event.track);
        }
        remoteVideo.play().catch(e => console.error("Error al reproducir video remoto:", e));
        hideConnecting();
      };

      // Manejo de ICE candidates locales
      peerConnection.onicecandidate = event => {
        if(event.candidate){
          console.log("Enviando ICE candidate:", event.candidate);
          database.ref(`calls/${callId}/iceCandidates/${currentUser.uid}`).push(JSON.stringify(event.candidate));
        }
      };

      // Escuchar ICE candidates remotos
      database.ref(`calls/${callId}/iceCandidates`).on('child_added', snapshot => {
        const userUid = snapshot.key;
        if(userUid !== currentUser.uid){
          snapshot.forEach(candidateSnap => {
            const candidateData = candidateSnap.val();
            if(candidateData){
              const candidate = new RTCIceCandidate(JSON.parse(candidateData));
              peerConnection.addIceCandidate(candidate).catch(e => console.error("Error agregando ICE candidate:", e));
            }
          });
        }
      });

      // Si es caller, crear y enviar oferta
      if(isCaller){
        createOffer(callId);
      } else {
        // Si es callee, esperar la oferta
        database.ref(`calls/${callId}/offer`).on('value', async snapshot => {
          const offerData = snapshot.val();
          if(offerData){
            try {
              const offer = new RTCSessionDescription(JSON.parse(offerData));
              await peerConnection.setRemoteDescription(offer);
              const answer = await peerConnection.createAnswer();
              await peerConnection.setLocalDescription(answer);
              await database.ref(`calls/${callId}/answer`).set(JSON.stringify(answer));
              console.log("Respuesta enviada");
            } catch(err){
              console.error("Error procesando la oferta:", err);
            }
          }
        });
      }

      // Procesar respuesta (solo para caller)
      database.ref(`calls/${callId}/answer`).on('value', async snapshot => {
        const answerData = snapshot.val();
        if(answerData && peerConnection.signalingState === 'have-local-offer'){
          try {
            const answer = new RTCSessionDescription(JSON.parse(answerData));
            await peerConnection.setRemoteDescription(answer);
            console.log("Respuesta recibida y aplicada");
          } catch(err){
            console.error("Error al aplicar respuesta:", err);
          }
        }
      });

      // Cargar datos del usuario remoto para mostrar nombre y avatar
      database.ref(`calls/${callId}/participants`).once('value', snap => {
        const parts = snap.val() || {};
        let remoteUid = isCaller ? parts.callee : parts.caller;
        console.log("remoteUid detectado:", remoteUid);
        if(!remoteUid){
          console.error("No se encontró remoteUid");
          document.getElementById('remoteName').textContent = "Desconocido";
          document.getElementById('remoteAvatar').src = '/api/placeholder/30/30';
          return;
        }
        database.ref('profiles/' + remoteUid).once('value', userSnap => {
          if(userSnap.exists()){
            const rProfile = userSnap.val();
            document.getElementById('remoteAvatar').src = rProfile.avatar_url || '/api/placeholder/30/30';
            document.getElementById('remoteName').textContent = rProfile.username || 'Desconocido';
          } else {
            console.error("No se encontró perfil para remoteUid:", remoteUid);
            document.getElementById('remoteName').textContent = "Desconocido";
            document.getElementById('remoteAvatar').src = '/api/placeholder/30/30';
          }
        });
      });
    }

    async function createOffer(callId){
      try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await database.ref(`calls/${callId}/offer`).set(JSON.stringify(offer));
        console.log("Oferta creada y enviada");
      } catch(error){
        console.error("Error creando oferta:", error);
      }
    }

    /* ====================== CONTROLES DE VIDEO/ AUDIO ====================== */
    function showConnecting(){
      document.getElementById('connectingIndicator').classList.add('active');
    }
    function hideConnecting(){
      document.getElementById('connectingIndicator').classList.remove('active');
    }
    function toggleAudio(){
      if(!localStream) return;
      localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
      document.getElementById('micIcon').classList.toggle('fa-microphone-slash');
      document.getElementById('micIcon').classList.toggle('fa-microphone');
    }
    function toggleVideo(){
      if(!localStream) return;
      localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
      document.getElementById('videoIcon').classList.toggle('fa-video-slash');
      document.getElementById('videoIcon').classList.toggle('fa-video');
    }
    function restartCall(){
      showConnecting();
      setTimeout(() => {
        hideConnecting();
        if(peerConnection) peerConnection.close();
        peerConnection = null;
        remoteStream = null;
        document.getElementById('remoteVideo').srcObject = null;
        if(currentCallId){
          database.ref('calls/' + currentCallId).remove();
          currentCallId = null;
        }
        findRandomUser();
      }, 2000);
    }

    /* ====================== GESTO PARA CAMBIAR DE USUARIO ====================== */
    let touchStartX = 0;
    let touchEndX = 0;
    document.querySelector('.video-container').addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });
    document.querySelector('.video-container').addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      if(touchEndX < touchStartX){
        restartCall();
      }
    });
  </script>
</body>
</html>
<!-- partial -->
  
</body>
</html>
